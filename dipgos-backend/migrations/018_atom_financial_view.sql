-- 018_atom_financial_view.sql
-- Synthetic atom financial allocations for utilisation and earned value tracking
SET search_path TO dipgos, public;

CREATE TABLE IF NOT EXISTS dipgos.atom_financial_allocations (
  id UUID PRIMARY KEY,
  tenant_id UUID NOT NULL,
  project_id UUID NOT NULL REFERENCES dipgos.entities(entity_id) ON DELETE CASCADE,
  contract_id UUID NULL REFERENCES dipgos.entities(entity_id) ON DELETE SET NULL,
  sow_id UUID NULL REFERENCES dipgos.entities(entity_id) ON DELETE SET NULL,
  process_id UUID NULL REFERENCES dipgos.entities(entity_id) ON DELETE SET NULL,
  atom_id UUID NOT NULL REFERENCES dipgos.atoms(id) ON DELETE CASCADE,
  basis TEXT NOT NULL CHECK (basis IN ('time', 'volume', 'sensor')),
  allocation_date DATE NOT NULL,
  start_ts TIMESTAMPTZ NULL,
  end_ts TIMESTAMPTZ NULL,
  busy_minutes INTEGER NOT NULL DEFAULT 0,
  idle_minutes INTEGER NOT NULL DEFAULT 0,
  billable_minutes INTEGER NOT NULL DEFAULT 0,
  non_billable_minutes INTEGER NOT NULL DEFAULT 0,
  quantity NUMERIC(14, 3),
  unit TEXT,
  time_rate NUMERIC(12, 2),
  unit_rate NUMERIC(12, 2),
  standby_rate NUMERIC(12, 2),
  overtime_multiplier NUMERIC(8, 4) NOT NULL DEFAULT 1.0,
  surcharge_multiplier NUMERIC(8, 4) NOT NULL DEFAULT 1.0,
  location TEXT,
  shift TEXT,
  status TEXT,
  notes TEXT,
  non_billable_reason TEXT,
  sensor_condition TEXT,
  planned_billable_minutes INTEGER,
  planned_earned NUMERIC(16, 2),
  created_at TIMESTAMPTZ NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_atom_financial_scope
  ON dipgos.atom_financial_allocations (tenant_id, project_id, contract_id, sow_id, process_id, atom_id);
CREATE INDEX IF NOT EXISTS idx_atom_financial_date
  ON dipgos.atom_financial_allocations (allocation_date);

-- Extend catalogue with cement and sensor assets plus expanded machinery records
WITH seed AS (
  SELECT
    '11111111-1111-1111-1111-111111111111'::uuid AS tenant_id,
    '22222222-2222-2222-2222-222222222222'::uuid AS contract_id
)
INSERT INTO dipgos.atom_groups (id, category, name, parent_id, tenant_id)
VALUES
  ('b0000000-0000-0000-0000-000000000013', 'consumables', 'Cementitious Materials', 'b0000000-0000-0000-0000-000000000020', (SELECT tenant_id FROM seed)),
  ('b0000000-0000-0000-0000-000000000061', 'technologies', 'Concrete Sensors', 'b0000000-0000-0000-0000-000000000060', (SELECT tenant_id FROM seed))
ON CONFLICT (id) DO NOTHING;

INSERT INTO dipgos.atom_types (id, group_id, category, name, spec, tenant_id)
VALUES
  ('c0000000-0000-0000-0000-000000000070', 'b0000000-0000-0000-0000-000000000013', 'consumables', 'Bulk Cement Bags', '{"packaging": "50kg"}'::jsonb, '11111111-1111-1111-1111-111111111111'),
  ('c0000000-0000-0000-0000-000000000080', 'b0000000-0000-0000-0000-000000000061', 'technologies', 'Concrete Strength Sensor', '{"vendor": "SensiCore"}'::jsonb, '11111111-1111-1111-1111-111111111111')
ON CONFLICT (id) DO NOTHING;

WITH seed AS (
  SELECT
    '11111111-1111-1111-1111-111111111111'::uuid AS tenant_id,
    '22222222-2222-2222-2222-222222222222'::uuid AS contract_id
)
INSERT INTO dipgos.atoms (id, atom_type_id, name, unit, contractor_id, home_entity_id, spec, tenant_id)
VALUES
  ('d0000000-0000-0000-0000-000000000070', 'c0000000-0000-0000-0000-000000000070', 'Cement Delivery Lot A', 'bags', NULL, (SELECT contract_id FROM seed), '{"storage": "Silo 3"}'::jsonb, (SELECT tenant_id FROM seed)),
  ('d0000000-0000-0000-0000-000000000080', 'c0000000-0000-0000-0000-000000000080', 'Concrete Sensor Node 12C', 'sensor', NULL, (SELECT contract_id FROM seed), '{"thresholdMPa": 28}'::jsonb, (SELECT tenant_id FROM seed)),
  ('d0000000-0000-0000-0000-000000000090', 'c0000000-0000-0000-0000-000000000010', 'Excavator CAT 395 #4', 'unit', NULL, (SELECT contract_id FROM seed), '{"capacityTons": 40}'::jsonb, (SELECT tenant_id FROM seed)),
  ('d0000000-0000-0000-0000-000000000091', 'c0000000-0000-0000-0000-000000000011', 'Bulldozer DBT #7', 'unit', NULL, (SELECT contract_id FROM seed), '{"horsepower": 360}'::jsonb, (SELECT tenant_id FROM seed))
ON CONFLICT (id) DO NOTHING;

-- Synthetic utilisation and billing records (covers time, volume, and sensor scenarios)
WITH scope AS (
  SELECT
    '11111111-1111-1111-1111-111111111111'::uuid AS tenant_id,
    '11111111-1111-1111-1111-111111111111'::uuid AS project_id,
    '22222222-2222-2222-2222-222222222222'::uuid AS contract_id,
    '33333333-3333-3333-3333-333333333333'::uuid AS sow_rcc_id,
    '44444444-4444-4444-4444-444444444444'::uuid AS proc_rcc_pour_id,
    '44444444-4444-4444-4444-444444444779'::uuid AS proc_dam_pit_id
)
INSERT INTO dipgos.atom_financial_allocations (
  id, tenant_id, project_id, contract_id, sow_id, process_id, atom_id,
  basis, allocation_date, start_ts, end_ts,
  busy_minutes, idle_minutes, billable_minutes, non_billable_minutes,
  quantity, unit, time_rate, unit_rate, standby_rate,
  overtime_multiplier, surcharge_multiplier,
  location, shift, status, notes, non_billable_reason, sensor_condition,
  planned_billable_minutes, planned_earned
)
VALUES
  -- Time-based billable window with clear utilisation
  ('f2000000-0000-0000-0000-000000000901',
   (SELECT tenant_id FROM scope), (SELECT project_id FROM scope), (SELECT contract_id FROM scope),
   (SELECT sow_rcc_id FROM scope), (SELECT proc_rcc_pour_id FROM scope), 'd0000000-0000-0000-0000-000000000090',
   'time',
   CURRENT_DATE,
   date_trunc('day', CURRENT_DATE)::timestamptz + INTERVAL '10 hours',
   date_trunc('day', CURRENT_DATE)::timestamptz + INTERVAL '17 hours',
   240, 0, 240, 0,
   NULL, NULL, 160.00, NULL, NULL,
   1.0, 1.0,
   'Gallery Lift 34', 'Day', 'billable',
   'Two pour windows: 10:00–12:00 and 15:00–17:00 keeping prime crew busy.',
   NULL, NULL,
   240, 720.00),
  -- Night shift with overtime multiplier applied
  ('f2000000-0000-0000-0000-000000000902',
   (SELECT tenant_id FROM scope), (SELECT project_id FROM scope), (SELECT contract_id FROM scope),
   (SELECT sow_rcc_id FROM scope), (SELECT proc_rcc_pour_id FROM scope), 'd0000000-0000-0000-0000-000000000090',
   'time',
   CURRENT_DATE - INTERVAL '2 days',
   date_trunc('day', CURRENT_DATE - INTERVAL '2 days')::timestamptz + INTERVAL '19 hours',
   date_trunc('day', CURRENT_DATE - INTERVAL '2 days')::timestamptz + INTERVAL '23 hours 30 minutes',
   210, 30, 210, 0,
   NULL, NULL, 165.00, NULL, NULL,
   1.5, 1.15,
   'Night bench cut', 'Night', 'billable',
   'Extended night dig with overtime and remote site surcharge.',
   NULL, NULL,
   180, 520.00),
  -- Maintenance window counted as non-billable idle
  ('f2000000-0000-0000-0000-000000000903',
   (SELECT tenant_id FROM scope), (SELECT project_id FROM scope), (SELECT contract_id FROM scope),
   (SELECT sow_rcc_id FROM scope), (SELECT proc_rcc_pour_id FROM scope), 'd0000000-0000-0000-0000-000000000090',
   'time',
   CURRENT_DATE - INTERVAL '3 days',
   date_trunc('day', CURRENT_DATE - INTERVAL '3 days')::timestamptz + INTERVAL '13 hours',
   date_trunc('day', CURRENT_DATE - INTERVAL '3 days')::timestamptz + INTERVAL '15 hours',
   0, 120, 0, 120,
   NULL, NULL, 0, NULL, NULL,
   1.0, 1.0,
   'Bench maintenance bay', 'Day', 'non_billable',
   'Internal rework and hydraulic flush following inspection.',
   'Internal rework/maintenance', NULL,
   120, 0.00),
  -- Historical production to support 7–14 day trends
  ('f2000000-0000-0000-0000-000000000904',
   (SELECT tenant_id FROM scope), (SELECT project_id FROM scope), (SELECT contract_id FROM scope),
   (SELECT sow_rcc_id FROM scope), (SELECT proc_rcc_pour_id FROM scope), 'd0000000-0000-0000-0000-000000000090',
   'time',
   CURRENT_DATE - INTERVAL '6 days',
   date_trunc('day', CURRENT_DATE - INTERVAL '6 days')::timestamptz + INTERVAL '09 hours 30 minutes',
   date_trunc('day', CURRENT_DATE - INTERVAL '6 days')::timestamptz + INTERVAL '14 hours',
   240, 30, 210, 0,
   NULL, NULL, 158.00, NULL, NULL,
   1.0, 1.0,
   'Lift 32 Pour Face', 'Day', 'billable',
   'Full day trench shaping ahead of mat pour.',
   NULL, NULL,
   210, 575.00),
  -- Standby coverage billed at standby rate
  ('f2000000-0000-0000-0000-000000000905',
   (SELECT tenant_id FROM scope), (SELECT project_id FROM scope), (SELECT contract_id FROM scope),
   (SELECT sow_rcc_id FROM scope), (SELECT proc_dam_pit_id FROM scope), 'd0000000-0000-0000-0000-000000000091',
   'time',
   CURRENT_DATE,
   date_trunc('day', CURRENT_DATE)::timestamptz + INTERVAL '18 hours',
   date_trunc('day', CURRENT_DATE)::timestamptz + INTERVAL '21 hours',
   180, 0, 180, 0,
   NULL, NULL, 55.00, NULL, 45.00,
   1.0, 1.0,
   'Dam pit north apron', 'Evening', 'standby',
   'Standby window covering potential flash pour change.',
   NULL, NULL,
   180, 210.00),
  ('f2000000-0000-0000-0000-000000000906',
   (SELECT tenant_id FROM scope), (SELECT project_id FROM scope), (SELECT contract_id FROM scope),
   (SELECT sow_rcc_id FROM scope), (SELECT proc_dam_pit_id FROM scope), 'd0000000-0000-0000-0000-000000000091',
   'time',
  CURRENT_DATE - INTERVAL '1 day',
  date_trunc('day', CURRENT_DATE - INTERVAL '1 day')::timestamptz + INTERVAL '07 hours',
  date_trunc('day', CURRENT_DATE - INTERVAL '1 day')::timestamptz + INTERVAL '11 hours',
  240, 0, 180, 0,
   NULL, NULL, 62.00, NULL, 45.00,
   1.0, 1.05,
   'Dam pit north apron', 'Day', 'billable',
   'Bulk push with partial standby after pour delayed by QC.',
   NULL, NULL,
   210, 260.00),
  ('f2000000-0000-0000-0000-000000000907',
   (SELECT tenant_id FROM scope), (SELECT project_id FROM scope), (SELECT contract_id FROM scope),
   (SELECT sow_rcc_id FROM scope), (SELECT proc_dam_pit_id FROM scope), 'd0000000-0000-0000-0000-000000000091',
   'time',
   CURRENT_DATE - INTERVAL '5 days',
   date_trunc('day', CURRENT_DATE - INTERVAL '5 days')::timestamptz + INTERVAL '06 hours 30 minutes',
   date_trunc('day', CURRENT_DATE - INTERVAL '5 days')::timestamptz + INTERVAL '12 hours',
   300, 0, 240, 0,
   NULL, NULL, 60.00, NULL, 40.00,
   1.25, 1.0,
   'Spillway access ramp', 'Day', 'billable',
   'Extended cut with overtime uplift to cover schedule gap.',
   NULL, NULL,
   240, 310.00),
  -- Volume-based billing tied to pour windows
  ('f2000000-0000-0000-0000-000000000908',
   (SELECT tenant_id FROM scope), (SELECT project_id FROM scope), (SELECT contract_id FROM scope),
   (SELECT sow_rcc_id FROM scope), (SELECT proc_rcc_pour_id FROM scope), 'd0000000-0000-0000-0000-000000000070',
   'volume',
   CURRENT_DATE,
   date_trunc('day', CURRENT_DATE)::timestamptz + INTERVAL '09 hours 30 minutes',
   date_trunc('day', CURRENT_DATE)::timestamptz + INTERVAL '11 hours',
   90, 30, 0, 0,
   20.0, 'bags', NULL, 4.00, NULL,
   1.0, 1.12,
   'Pour line 7', 'Day', 'billable',
   '20 bag batch tied to gallery lift placement with location surcharge.',
   NULL, NULL,
   NULL, 95.00),
  ('f2000000-0000-0000-0000-000000000909',
   (SELECT tenant_id FROM scope), (SELECT project_id FROM scope), (SELECT contract_id FROM scope),
   (SELECT sow_rcc_id FROM scope), (SELECT proc_rcc_pour_id FROM scope), 'd0000000-0000-0000-0000-000000000070',
   'volume',
   CURRENT_DATE - INTERVAL '2 days',
   date_trunc('day', CURRENT_DATE - INTERVAL '2 days')::timestamptz + INTERVAL '08 hours 45 minutes',
   date_trunc('day', CURRENT_DATE - INTERVAL '2 days')::timestamptz + INTERVAL '10 hours 15 minutes',
   75, 15, 0, 0,
   18.0, 'bags', NULL, 4.10, NULL,
   1.0, 1.0,
   'Pour line 6', 'Day', 'billable',
   'Adjusted mix for early strength sections.',
   NULL, NULL,
   NULL, 80.00),
  ('f2000000-0000-0000-0000-00000000090A',
   (SELECT tenant_id FROM scope), (SELECT project_id FROM scope), (SELECT contract_id FROM scope),
   (SELECT sow_rcc_id FROM scope), (SELECT proc_rcc_pour_id FROM scope), 'd0000000-0000-0000-0000-000000000070',
   'volume',
   CURRENT_DATE - INTERVAL '5 days',
   date_trunc('day', CURRENT_DATE - INTERVAL '5 days')::timestamptz + INTERVAL '09 hours',
   date_trunc('day', CURRENT_DATE - INTERVAL '5 days')::timestamptz + INTERVAL '11 hours',
   90, 30, 0, 0,
   22.0, 'bags', NULL, 3.95, NULL,
   1.0, 0.98,
   'Pour line 5', 'Day', 'billable',
   'Bulk placement with slight discount for supplier rebate.',
   NULL, NULL,
   NULL, 86.00),
  -- Sensor-dependent monitoring, billed until condition met
  ('f2000000-0000-0000-0000-00000000090B',
   (SELECT tenant_id FROM scope), (SELECT project_id FROM scope), (SELECT contract_id FROM scope),
   (SELECT sow_rcc_id FROM scope), (SELECT proc_rcc_pour_id FROM scope), 'd0000000-0000-0000-0000-000000000080',
   'sensor',
   CURRENT_DATE - INTERVAL '1 day',
   date_trunc('day', CURRENT_DATE - INTERVAL '1 day')::timestamptz + INTERVAL '22 hours',
   date_trunc('day', CURRENT_DATE)::timestamptz + INTERVAL '04 hours',
   360, 0, 360, 0,
   NULL, NULL, 85.00, NULL, NULL,
   1.0, 1.18,
   'Thermal soak bay', 'Night', 'billable',
   'Monitoring until curing strength hit 28 MPa threshold.',
   NULL, 'Reached 28 MPa at 04:00',
   360, 420.00),
  ('f2000000-0000-0000-0000-00000000090C',
   (SELECT tenant_id FROM scope), (SELECT project_id FROM scope), (SELECT contract_id FROM scope),
   (SELECT sow_rcc_id FROM scope), (SELECT proc_rcc_pour_id FROM scope), 'd0000000-0000-0000-0000-000000000080',
   'sensor',
   CURRENT_DATE - INTERVAL '3 days',
   date_trunc('day', CURRENT_DATE - INTERVAL '3 days')::timestamptz + INTERVAL '21 hours 30 minutes',
   date_trunc('day', CURRENT_DATE - INTERVAL '2 days')::timestamptz + INTERVAL '03 hours 30 minutes',
   360, 0, 300, 0,
   NULL, NULL, 82.00, NULL, NULL,
   1.0, 1.05,
   'Thermal soak bay', 'Night', 'billable',
   'Sensor held until mix reached required maturity.',
   NULL, 'Strength plateau at 25 MPa awaiting finish',
   330, 380.00),
  ('f2000000-0000-0000-0000-00000000090D',
   (SELECT tenant_id FROM scope), (SELECT project_id FROM scope), (SELECT contract_id FROM scope),
   (SELECT sow_rcc_id FROM scope), (SELECT proc_rcc_pour_id FROM scope), 'd0000000-0000-0000-0000-000000000080',
   'sensor',
   CURRENT_DATE - INTERVAL '6 days',
   date_trunc('day', CURRENT_DATE - INTERVAL '6 days')::timestamptz + INTERVAL '21 hours',
   date_trunc('day', CURRENT_DATE - INTERVAL '5 days')::timestamptz + INTERVAL '03 hours',
   360, 0, 360, 0,
   NULL, NULL, 80.00, NULL, NULL,
   1.0, 1.0,
   'Gallery thermal bay', 'Night', 'billable',
   'Standard curing cycle monitoring.',
   NULL, 'Reached 26 MPa at 02:40',
   360, 400.00)
ON CONFLICT (id) DO NOTHING;
